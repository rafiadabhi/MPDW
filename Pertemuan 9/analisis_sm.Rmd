---
title: "Analisis Kelompok 4"
author: "Kelompok 4"
date: "2025-10-02"
output:
  html_document:
    toc: true
    toc_float: true
    theme: sandstone
    highlight: zenburn
  pdf_document:
    toc: true
---

## 1. Packages
```{r message=FALSE, warning=FALSE}
library(rio)
library(ggplot2)
library(tsibble)
library(tseries)
library(MASS)
library(readr)
library(TSA)
library(forecast)
library(lubridate)
library(readxl)
library(rio)
library(ggplot2)
library(tsibble)
library(tseries)
library(MASS)
library(readr)
library(TSA)
library(forecast)
```

## 2. Import Data
```{r}
url <- "https://raw.githubusercontent.com/rafiadabhi/MPDW/main/Pertemuan%201/Data/SM_Rata2_Mingguan_Indramayu_2014_2023.xlsx"
temp_file <- tempfile(fileext = ".xlsx")
download.file(url, destfile = temp_file, mode = "wb")
df <- read_excel(temp_file)

df_values <- df$sm

start_date <- df[[1]][1] 
start_year <- as.integer(format(start_date, "%Y"))
start_week <- as.integer(format(start_date, "%W")) + 1 

date_col <- df[[1]]
full_year_vector <- as.integer(format(date_col, "%Y"))

data <- ts(
  df_values, 
  start = c(start_year, start_week), 
  frequency = 52
)

class(data)
```

### 2.1 Karakteristik Data
```{r}
length(data) 
head(data)     
tail(data)     
is.numeric(data)  
```

### 2.2 Data Spliting
```{r}
train_data <- subset(data,start=1,end=417)
test_data <- subset(data,start=418,end=522)
```

## 3. Eksplorasi Data

```{r}
summary(data)
```

### 3.1 Plot Data Penuh
```{r}
plot.ts(data, 
        lty = 1, 
        xlab = "Tahun", 
        ylab = "SM", 
        main = "Plot Kelembaban Tanah")
```

```{r}
ts.plot(data, type="l", xlab = "Tahun", ylab="SM", col="blue")
title(main = "Plot Kelembaban Tanah", cex.sub = 0.8)
points(data, pch = 1, col = "blue")
```

### 3.2 Plot Data Latih
```{r}
autoplot(train_data) + theme_bw() + xlab("Year") + ylab("Soil Moisture")
```

### 3.3 Plot Data Uji
```{r}
autoplot(test_data) + theme_bw() + xlab("Year") + ylab("Soil Moisture")
```

### 3.3 Plot Seasonal
```{r}
data.tss <- ts(data, frequency = 52, start = c(2014, 1))
dec.data <- decompose(data.tss)
plot(dec.data)
```

```{r}
par(mar=c(5, 4, 4, 6) + 0.1, xpd=TRUE)
seasonplot(data,52,main="Seasonal Plot of Soil Moisture", ylab="Year",
           year.labels = TRUE, col=rainbow(10))
par(mar=c(5, 4, 4, 2) + 0.1)
```


```{r}
monthplot(data.tss,ylab="Soil Moisture", col="blue")
```

```{r}
n <- length(data)                 
n_train <- floor(0.8 * n)  
full_year_vector <- as.integer(format(df[[1]], "%Y"))
train_year_vector <- full_year_vector[1:n_train]

frame_fligner_train <- data.frame(
  values = as.numeric(train_data), 
  date_year = factor(train_year_vector) # Kelompokkan berdasarkan Tahun (seharusnya 10 level)
)

library(ggplot2)
ggplot(frame_fligner_train, aes(y=values, x=date_year)) +
  geom_boxplot() +
  labs(
    title = "Variabilitas Kelembaban Tanah Mingguan Berdasarkan Tahun",
    x = "Tahun",
    y = "Rata-rata SM Mingguan"
  ) +
  theme_minimal()
```

## 4. Non-seasonal ARIMA

### 4.1 Stasioneritas

```{r}
# Uji Box-Cox
index <- seq(length(train_data))
bc <- boxcox(
  train_data - min(train_data) + 0.0000001 ~ index,
  lambda = seq(0.5, 1.5, by = 0.001)
)
```
```{r}
lambda_opt <- bc$x[which.max(bc$y)]
lambda_opt
```
```{r}
# Selang kepercayaan 95% untuk lambda
ci_lambda <- bc$x[bc$y > max(bc$y) - 0.5 * qchisq(0.95, 1)]

# Batas bawah dan batas atas
ci_lower <- min(ci_lambda)
ci_upper <- max(ci_lambda)

c(Batas_Bawah = ci_lower, Batas_Atas = ci_upper)
```
Hasil uji Box–Cox menunjukkan bahwa nilai λ optimum adalah 1,195 dengan interval kepercayaan 95% sebesar (0,988–1,413). Karena selang tersebut memuat nilai λ = 1, maka dapat disimpulkan bahwa data sudah stasioner dalam ragam


```{r}
acf(train_data, lag.max = 520, main = "ACF Plot", col = "blue")
```

```{r}
acf(train_data)
```

```{r}
acf0 <- acf(train_data, main = "ACF", lag.max = 520, plot = FALSE)
acf0$lag <- acf0$lag * 52
acf_df <- data.frame(acf = acf0$acf, lag = acf0$lag)

acf_year <- acf_df[acf_df$lag %% 52 == 0, ]   # ← koma di sini penting!

barplot(
  height = acf_year$acf,
  names.arg = acf_year$lag,
  ylab = "ACF",
  xlab = "Lag (mingguan)",
  main = "Autokorelasi Tahunan Kelembaban Tanah"
)
```

```{r}
tseries::adf.test(train_data)
```

$H_0$ : Data tidak stasioner dalam rataan 
$H_1$ : Data stasioner dalam rataan

Berdasarkan uji ADF tersebut, didapat p-value sebesar 0.01 yang lebih kecil dari taraf nyata 5% sehingga tolak $H_0$ dan menandakan bahwa data sudah stasioner dalam rataan.

## 5. Seasonal ARIMA

```{r}
D1 <- diff(train_data, lag = 52)
ts.plot(D1, type="l", ylab="y_diff1 Xt", col="blue")
```
```{r}
acf2 <- acf(D1, lag.max = 30, xaxt = "n", main = "ACF D1", col = "blue")
```

```{r}
acf0 <- acf(D1, main = "ACF", lag.max = 520, plot = FALSE)
acf0$lag <- acf0$lag * 52
acf_df <- data.frame(acf = acf0$acf, lag = acf0$lag)

acf_year <- acf_df[acf_df$lag %% 52 == 0, ]   # ← koma di sini penting!

barplot(
  height = acf_year$acf,
  names.arg = acf_year$lag,
  ylab = "ACF",
  xlab = "Lag (mingguan)",
  main = "Autokorelasi Tahunan Kelembaban Tanah"
)
```

Non-seasonal differencing D = 52 berhasil mengatasi ketidakstasioneran dalam rataan untuk komponen seasonalnya (namun tidak untuk komponen non-seasonalnya).

```{r}
d1D1 <- diff(D1)
ts.plot(d1D1, type="l", ylab="d1 D1 Xt", col="blue")
```

```{r}
acf0 <- acf(d1D1, main = "ACF", lag.max = 520, plot = FALSE)
acf0$lag <- acf0$lag * 52
acf_df <- data.frame(acf = acf0$acf, lag = acf0$lag)

acf_year <- acf_df[acf_df$lag %% 52 == 0, ]   # ← koma di sini penting!

barplot(
  height = acf_year$acf,
  names.arg = acf_year$lag,
  ylab = "ACF",
  xlab = "Lag (mingguan)",
  main = "Autokorelasi Tahunan Kelembaban Tanah"
)
```


### 5.1 Identifikasi Model
```{r}
par(mfrow = c(1,2))
acf(d1D1, lag.max = 10, main = "ACF after seasonal diff (D=1)")
pacf(d1D1, lag.max = 10, main = "PACF after seasonal diff (D=1)")
par(mfrow = c(1,1))
```

```{r}
eacf(d1D1)
```
```{r}
tmodel1 <- Arima(train_data,order=c(1,0,2),seasonal=c(1,1,0))
summary(tmodel1)
```


```{r}
fit_auto <- auto.arima(train_data, d = 0, D = 1, seasonal = TRUE,
                       max.P = 2, max.Q = 2, max.order = 2,
                       stepwise = FALSE, approximation = FALSE)
summary(fit_auto)
```
```{r}
tmodel1 <- Arima(train_data,order=c(1,0,1),seasonal=c(1,1,0))
summary(tmodel1)
```

```{r}
tmodel1 <- Arima(train_data,order=c(1,0,0),seasonal=c(1,1,0))
summary(tmodel1)
```

```{r}
lmtest::coeftest(tmodel1)
```

### 5.3. Overfitting
```{r}
tmodel1.ofq <- Arima(train_data,order=c(2,0,0),seasonal=c(1,1,0))
summary(tmodel1.ofq)
```
```{r}
lmtest::coeftest(tmodel1.ofq)
```

```{r}
tmodel1.ofP <- Arima(train_data,order=c(1,0,0),seasonal=c(2,1,0))
summary(tmodel1.ofP)
```

```{r}
lmtest::coeftest(tmodel1.ofP)
```
jadi pake model ARIMA(1,0,0)(2,1,0)
### 5.2. Diagnostik Model
```{r}
tsdisplay(residuals(tmodel1), lag.max=520, 
          main='ARIMA(1,0,0)(1,1,0)52 Model Residuals', col="blue")
```

```{r}
#Eksplorasi
sisaan.model1 <- tmodel1$residuals
par(mfrow=c(2,2))
car::qqPlot(sisaan.model1)
```
```{r}
plot(c(1:length(sisaan.model1)),sisaan.model1)
acf(sisaan.model1)
pacf(sisaan.model1)
```

#### 5.2.1 Uji Formal
```{r}
#1) Sisaan Menyebar Normal
ks.test(sisaan.model1,"pnorm")
shapiro.test(sisaan.model1)
nortest::ad.test(sisaan.model1)
```
```{r}
#2) Sisaan saling bebas/tidak ada autokorelasi
Box.test(sisaan.model1, type = "Ljung") 
```

```{r}
#3) Sisaan homogen 
Box.test((sisaan.model1)^2, type = "Ljung")  
```
```{r}
#4) Nilai tengah sisaan sama dengan nol 
t.test(sisaan.model1, mu = 0, conf.level = 0.95) 
```
### 5.3 Peramalan 

```{r}
ramalan_sarima = forecast::forecast(tmodel1, 52)
ramalan_sarima
```

```{r}
autoplot(ramalan_sarima, col="blue")
```

```{r}
accuracy(ramalan_sarima,test_data)
```

